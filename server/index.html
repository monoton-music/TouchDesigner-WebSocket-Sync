<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>TD Sync</title>
  <style>
    body { background: #000; color: #fff; font-family: monospace; margin: 2rem; }
    h1 { font-size: 1rem; font-weight: normal; color: #666; margin: 0 0 1rem; }
    .row { display: flex; align-items: center; gap: 1rem; }
    input[type="range"] { width: 300px; }
    input[type="number"] {
      width: 80px;
      background: #111;
      border: 1px solid #333;
      color: #fff;
      font-family: monospace;
      font-size: 1rem;
      padding: 0.25rem 0.5rem;
      text-align: right;
    }
    input[type="number"]:focus { outline: 1px solid #666; }
  </style>
</head>
<body>
  <h1>TouchDesigner WebSocket Sync</h1>
  <div class="row">
    <input type="range" id="slider" min="0" max="1" step="0.001" value="0">
    <input type="number" id="number" min="0" max="1" step="0.001" value="0">
  </div>
  <script>
    const slider = document.getElementById('slider');
    const number = document.getElementById('number');
    let ws = null;
    let fromServer = false;

    function connect() {
      ws = new WebSocket(`ws://${location.host}`);
      ws.onclose = () => setTimeout(connect, 2000);
      ws.onmessage = (e) => {
        const msg = JSON.parse(e.data);
        if (msg.type === 'valueChange' && msg.name === 'Value') {
          fromServer = true;
          slider.value = msg.value;
          number.value = parseFloat(msg.value).toFixed(3);
          fromServer = false;
        }
      };
    }

    function sendValue(value) {
      if (!fromServer && ws?.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'setValue', name: 'Value', value: parseFloat(value) }));
      }
    }

    slider.addEventListener('input', (e) => {
      number.value = parseFloat(e.target.value).toFixed(3);
      sendValue(e.target.value);
    });

    number.addEventListener('input', (e) => {
      let val = parseFloat(e.target.value) || 0;
      val = Math.max(0, Math.min(1, val));
      slider.value = val;
      sendValue(val);
    });

    connect();
  </script>
</body>
</html>
